CC = g++

MKLROOT = /home/elliotliu/miniconda
export LD_LIBRARY_PATH=/home/elliotliu/miniconda/lib:$LD_LIBRARY_PATH

CFLAGS = -O3 -Wall -pthread -std=c++17 -m64 -DMKL_ILP64 -mavx2 -mfma -ffast-math -DUSE_INT8_INT4_PRODUCT -fpermissive -DQM_x86 -DUSE_MKL
INCLUDE_DIRS = -I$(LIB_DIR) -I./include -I./include/nn_modules -I./json/single_include/ -I./half-2.2.0/include/ -I/home/elliotliu/miniconda/include
LDFLAGS = -Wl,--start-group /home/elliotliu/miniconda/lib/libmkl_intel_ilp64.so /home/elliotliu/miniconda/lib/libmkl_gnu_thread.so /home/elliotliu/miniconda/lib/libmkl_core.so -Wl,--end-group -lgomp -lpthread -lm -ldl
LIB_DIR = ../kernels

# Check for ARM NEON and Accelerate framework
ifdef USE_ACCELERATE
    CFLAGS += -DUSE_ACCELERATE
    LDFLAGS += -framework Accelerate
endif

ifdef QM_ARM
    CFLAGS += -DQM_ARM
    LDFLAGS += -march=armv8-a+simd
endif

TARGET_DIR = ../experiments/
KERNEL_DIR = ../kernels/

SRC = $(TARGET_DIR)benchmark_t5.cc ../kernels/pthread_pool.cc 
LIB_AVX_SRC = $(wildcard $(LIB_DIR)/avx/*.cc)
SRC += $(LIB_AVX_SRC)

# ../kernels/neon/matmul_neon_int4.cc ../kernels/neon/matmul_neon_fp32.cc

HEADERS = ../kernels/matmul.h ../kernels/pthread_pool.h llm/include/common.h
OBJ = $(SRC:.cpp=.o)

all: benchmark_t5
	$(TARGET_DIR)benchmark_t5

benchmark_t5: $(OBJ)
	$(CC) $(CFLAGS) $(INCLUDE_DIRS) -o $(TARGET_DIR)benchmark_t5 $(OBJ) $(LDFLAGS)

%.o: %.cc $(HEADERS)
	$(CC) $(CFLAGS) $(INCLUDE_DIRS) -c $< -o $@

clean:
	rm -f $(OBJ) $(TARGET_DIR)benchmark_t5